#!/bin/sh
#
# selectively configure wireless access point with libertas firmware.

echo "Configuring WIFI..."

# If users have selected non-free packages, install firmware-libertas.
. machine-detect
if [ "$MACHINE" = "dreamplug" ]
then
    if [ -n "`grep non-free /etc/apt/sources.list`" ]
    then
        echo "Installing non-free WIFI package: firmware-libertas..."
        apt-get install firmware-libertas

	echo "Creating WIFI AP connection..."
	nmcli con add con-name freedomboxAP ifname uap0 \
	      type wifi ssid freedombox ip4 192.168.2.1/24
	nmcli con modify freedomboxAP connection.autoconnect TRUE
	nmcli con modify freedomboxAP connection.zone internal
	nmcli con modify freedomboxAP wifi.mode ap
	nmcli con modify freedomboxAP wifi-sec.key-mgmt wpa-psk
	nmcli con modify freedomboxAP wifi-sec.psk freedombox123

    else
        echo "Non-free packages disabled.  Skipping DreamPlug WIFI config."
    fi
else
    echo "Not a DreamPlug.  Skipping DreamPlug WIFI config."
fi

echo "Done Configuring WIFI."
