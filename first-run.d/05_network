#!/bin/sh

if dreamplug-detect ; then
    MACHINE=dreamplug
fi

case "$MACHINE" in
    dreamplug)
	echo "Setting up network configuration"

	rm -f /etc/udev/rules.d/75-persistent-net-generator.rules

	cat > /etc/network/interfaces <<EOF
# This file describes the network interfaces available on your system
# and how to activate them. For more information, see interfaces(5).

# The loopback network interface
auto lo
iface lo inet loopback

# The primary network interface
auto eth0
iface eth0 inet static
    address 192.168.1.1
    netmask 255.255.255.0

auto eth1
iface eth1 inet dhcp

# auto uap0
# iface uap0 inet static
#     address 192.168.2.1
#     netmask 255.255.255.0
#     post-up uaputl sys_cfg_ssid "freedombox"
#     post-up uaputl sys_cfg_protocol 32  # WPA2
#     post-up uaputl sys_cfg_wpa_passphrase "freedombox123"
#     post-up uaputl sys_cfg_cipher 8 8   # AES CCMP
#     post-up uaputl bss_start
EOF

    # always name interfaces in same order as MAC addresses
    service networking restart
    MACS=$(ifconfig | grep HWaddr | cut -c39-55 | sort)
    COUNT=0
    for MAC in $MACS; do
        cat >> /etc/udev/rules.d/70-persistent-net.rules <<EOF
SUBSYSTEM=="net", ACTION=="add", DRIVERS=="?*", ATTR{address}=="$MAC", ATTR{dev_id}=="0x0", ATTR{type}=="1", KERNEL=="eth*", NAME="eth$COUNT"
EOF
    COUNT=$((COUNT+1))
    done
	;;
esac
