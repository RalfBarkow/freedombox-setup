#!/bin/sh

. $(dirname $0)/testsuite-functions

netstat_check `tor-get-orport` tcp tor
netstat_check 9050 tcp tor

ips=$(ip -4 -o addr | awk '!/^[0-9]*: ?lo|link\/ether/ {gsub("/", " "); print $4}')
for ip in $ips
do
    # Check that Tor control socket only listens on localhost.
    if `echo QUIT | nc $ip 9051 2>&1 | grep -q "Connection refused"` ; then
        success "$0: Tor control socket is not listening on $ip."
    else
        error "$0: Tor control socket is listening on $ip."
    fi

    # Check that Tor Socks listens on every interface.
    netstat_check_socket $ip:9050 tcp tor
done

if torsocks wget -O - http://www.debian.org/ 2>/dev/null | \
    grep -q '<html'; then
    success "$0: HTTP request to www.debian.org via TOR works."
else
    error "$0: HTTP request to www.debian.org via TOR fail."
fi

if torsocks wget -O - https://check.torproject.org/ 2>/dev/null | \
    grep -q 'Congratulations. This browser is configured to use Tor.'; then
    success "$0: HTTP request to check.torproject.org via TOR confirm that TOR is used."
else
    error "$0: HTTP request to check.torproject.org via TOR confirm that TOR is not used."
fi

