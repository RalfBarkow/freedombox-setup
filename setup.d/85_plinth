#!/bin/sh
#
# Add port forwarding from public port 8001 to plinth port 8000
# on localhost.

echo "Configuring Plinth..."

cat > /etc/apache2/sites-available/plinth.conf <<END
<VirtualHost *:8001>
        ServerAdmin webmaster@localhost

        <Location />
                ProxyPass http://127.0.0.1:8000/
                Order allow,deny
                Allow from 10.0.0.0/8
                Allow from 172.16.0.0/12
                Allow from 192.168.0.0/16
        </Location>

        ErrorLog ${APACHE_LOG_DIR}/error.log

        # Possible values include: debug, info, notice, warn, error, crit,
        # alert, emerg.
        LogLevel warn

        CustomLog ${APACHE_LOG_DIR}/access.log combined

        <IfModule mod_ssl.c>
	        SSLEngine on
            SSLCertificateFile /etc/ssl/certs/ssl-cert-snakeoil.pem
            SSLCertificateKeyFile /etc/ssl/private/ssl-cert-snakeoil.key
        </IfModule>

</VirtualHost>
END
cat > /etc/apache2/freedombox-ports.conf <<END
Listen 0.0.0.0:8001
END
if [ -z "`grep 'freedombox-ports.conf' /etc/apache2/ports.conf`" ];then
    cat >> /etc/apache2/ports.conf <<END
Include freedombox-ports.conf
END
fi
a2ensite plinth.conf
echo "Done configuring Plinth.."
